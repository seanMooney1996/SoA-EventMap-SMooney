@page "/ticketmaster-search"
@implements IDisposable
@using SoACA1v2.DataModels
@using SoACA1v2.Services.StateManagement
@inject IWebHostEnvironment Env
@inject SearchStateService SearchStateService
@using System.Text.Json
@rendermode InteractiveServer
<div class="card shadow-sm p-3 search-card">
    <div class="row">
        <div class="col col75">
            <label class="form-label fw-semibold">Keywords</label>
            <TextInput @bind-Value="@Keywords"
                       Placeholder="Enter keywords..."
                       Class="form-control" />
        </div>
        <div class="col col25">
            <label class="form-label fw-semibold">Genre</label>
            <div class="input-group">
                <AutoComplete @bind-Value="GenreName"
                              TItem="GenreItem"
                              DataProvider="GenresDataProvider"
                              PropertyName="Name"
                              Placeholder="Select a genre..."
                              OnChanged="OnGenreSelected" 
                              Class="auto-comp" />
                <button class="btn btn-outline-secondary btn-search" type="button" @onclick="ClearGenre">
                    Clear
                </button>
            </div>
        </div>
    </div>
    
    <div class="row">
        <div class="col col50">
            <label class="form-label fw-semibold">Country</label>
            <div class="input-group">
                <AutoComplete @bind-Value="CountryName"
                              TItem="CountryItem"
                              DataProvider="CountryDataProvider"
                              PropertyName="Name"
                              Placeholder="Select a country..."
                              OnChanged="OnCountrySelected" />
                <button class="btn btn-outline-secondary" type="button" @onclick="ClearCountry">
                    Clear
                </button>
            </div>
        </div>
        <div class="col col25">
            <label class="form-label fw-semibold">Start Date</label>
            <DateInput TValue="DateOnly"
                       @bind-Value="StartDate"
                       Placeholder="Start date"
                       Class="form-control-date" />
        </div>
        <div class="col col25">
            <label class="form-label fw-semibold">End Date</label>
            <DateInput TValue="DateOnly"
                       @bind-Value="EndDate"
                       Placeholder="End date"
                       Class="form-control-date" />
        </div>
    </div>
</div>
@code {
    private List<GenreItem> GenreList = new();
    private List<CountryItem> CountryList = new();
    
    private string? GenreName;
    private string? CountryName;

    private string Keywords
    {
        get => SearchStateService.Keywords;
        set => SearchStateService.Keywords = value;
    }
    private DateOnly StartDate
    {
        get => SearchStateService.StartDate;
        set => SearchStateService.StartDate = value;
    }

    private DateOnly EndDate
    {
        get => SearchStateService.EndDate;
        set => SearchStateService.EndDate = value;
    }

    protected override async Task OnInitializedAsync()
    {
        SearchStateService.OnChange += StateHasChanged;

        await LoadGenres();
        await LoadCountries();

        GenreName = SearchStateService.SelectedGenre?.Name;
        CountryName = SearchStateService.SelectedCountry?.Name;
    }
    
    private void ClearGenre()
    {
        OnGenreSelected(new GenreItem()); 
    }

    private void ClearCountry()
    {
        OnCountrySelected(new CountryItem());
    }

    private async Task LoadGenres()
    {
        try
        {
            var filePath = Path.Combine(Env.WebRootPath, "genre_name_to_id.json");
            var json = await File.ReadAllTextAsync(filePath);
            var map = JsonSerializer.Deserialize<Dictionary<string, string>>(json);

            if (map is not null)
                GenreList = map.Select(g => new GenreItem { Name = g.Key, Id = g.Value }).ToList();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading genres: {ex.Message}");
        }
    }

    private async Task LoadCountries()
    {
        try
        {
            var filePath = Path.Combine(Env.WebRootPath, "countries.json");
            var json = await File.ReadAllTextAsync(filePath);
            var map = JsonSerializer.Deserialize<Dictionary<string, string>>(json);

            if (map is not null)
                CountryList = map.Select(c => new CountryItem { Name = c.Key, Code = c.Value }).ToList();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading countries: {ex.Message}");
        }
    }

    private async Task<AutoCompleteDataProviderResult<GenreItem>> GenresDataProvider(AutoCompleteDataProviderRequest<GenreItem> request)
        => await Task.FromResult(request.ApplyTo(GenreList.OrderBy(g => g.Name)));

    private async Task<AutoCompleteDataProviderResult<CountryItem>> CountryDataProvider(AutoCompleteDataProviderRequest<CountryItem> request)
        => await Task.FromResult(request.ApplyTo(CountryList.OrderBy(c => c.Name)));

    private void OnGenreSelected(GenreItem? genre)
    {
        if (genre is null) return;

        GenreName = genre.Name;
        SearchStateService.SelectedGenre = genre;
    }

    private void OnCountrySelected(CountryItem? country)
    {
        if (country is null) return;

        CountryName = country.Name;
        SearchStateService.SelectedCountry = country;
    }

    public void Dispose()
    {
        SearchStateService.OnChange -= StateHasChanged;
    }
}
<style>
    .col25 {
        width: 25%;
        max-width: 25%;
    }
    .col25 input {
        width: 95%!important;
    }
    .col50 {
        width: 50%;
    }
    .col75 {
        width: 75%;
    }
    .col75 .form-control {
        width: 98%!important;
    }
    .col75 .form-control input {
        max-width: 100%!important;
    }
    .col{
        max-height:100%;
        margin:0!important;
        padding: 0!important;
    }
    .row {
        display: flex;
        align-content: center;
        height: 45%;
        margin: 0 !important;
        padding: 0 !important;
        align-items: center;
        justify-content: flex-start;
    }
    .search-card {
        background-color: #fff;
        border-radius: 12px;
        padding: 1.5rem;
    }

    .form-label {
        flex: 0 0 30%; 
        display: flex;
        align-items: flex-end; 
        font-size: 1em;
        margin:0!important;
    }

    .input-group{
        position: relative;
        display: flex;
        align-items: center;
        width: 100%;
        flex-direction: row;
        justify-content: center;
        align-content: center;
        flex-wrap: nowrap;
    }
    .input-group- .auto-comp {
        width:100%;
    }
    .form-control{
        font-size: 1rem;
        max-height: 60%;
    }

    .input-group .btn {
        min-width: 70px;
        max-height: 60%;
        width:18%;
        
    }
    .input-group input {
        width:78%!important;
    }
    
    .form-control-date input {
        width: 95% !important;
    }
    
    .btn-search {
        max-width: 20%!important;
    }
    .autocomplete {
        width: 80%!important;
    }
    .dropdown-menu {
        z-index: 9999 !important;
    }
    .bi{
        display: none;
    }
    
</style>
