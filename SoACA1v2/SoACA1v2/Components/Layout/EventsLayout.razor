@using SoACA1v2.DataModels
@using SoACA1v2.Services
@using SoACA1v2.Services.StateManagement
@rendermode InteractiveServer
@inject EventStateService EventStateService


<div class="event-grid shadow-sm">
    <h2 style="margin-bottom: 0;color:#4285f4">Events</h2>
    @if (IsLoading)
    {
        <div class="loader_events"></div>
    }
    else if (!string.IsNullOrEmpty(ErrorMessage))
    {
        <p class="text-danger">@ErrorMessage</p>
    }
    else if (Events?.Any() == true)
    {
        <CardGroup>
            @foreach (var (e, index) in EventStateService.Events.Select((e, index) => (e, index)))
            {
                <Card class="event-card">
                    <img src="@e.Images?.FirstOrDefault()?.Url"
                         alt="@e.Name"
                         class="card-img-top event-img"/>
                    <CardBody>
                        <div class="card-body-inner">
                            <div class="text-inner-card">
                                <CardTitle>@e.Name</CardTitle>
                                <CardText>@e.Embedded.Venues[0].City.Name</CardText>
                                <CardText>@e.Embedded.Venues[0].Name</CardText>
                                <CardText>@e.Dates?.Start?.LocalDate</CardText>
                            </div>
                          
                            <div style="height:50px; display:flex;align-items: center;">
                                @if (!string.IsNullOrEmpty(@e.Embedded.Venues[0].Name))
                                {
                                    <Button Color="ButtonColor.Primary" @onclick="((args) => FindEventClicked(args, index))">Map</Button>
                                }
                            </div>
                        </div>
                    </CardBody>
                </Card>
            }
        </CardGroup>
    }
    else
    {
        <p>No events found.</p>
    }
</div>

@code {
    private List<Event>? Events;
    private bool IsLoading;
    private string? ErrorMessage;

    protected override void OnInitialized()
    {
        EventStateService.OnChange += OnEventStateChanged;
        SyncState();
    }

    private void FindEventClicked(EventArgs args, int index)
    {
        Console.WriteLine($"Locating event at index --- {index} ");
        EventStateService.EventToLocateIndex = index;
    }

    private async void OnEventStateChanged()
    {
        await InvokeAsync(() =>
        {
            SyncState();
            StateHasChanged();
        });
    }

    private void SyncState()
    {
        Events = EventStateService.Events ?? new List<Event>();
        IsLoading = EventStateService.IsLoading;
        ErrorMessage = EventStateService.ErrorMessage;
        Console.WriteLine($"Synced state: {Events.Count} events , is Loading {IsLoading}");
    }
}

<style>
    .card-body h1, h2, h3, h4, h5, h6, p {
        margin: 0!important;
        padding: 0!important;
    }
    .text-inner-card{
        height: 80%;
        h5{
            text-align: center;
            font-size: 15px;
            margin-bottom:5px!important;
            margin-top:5px!important;
            min-height:60px;
            font-weight: bold;
        }
        p{
            text-align: center;
            font-size: 14px;
        }
    }
    .card-body-inner {
        display: flex;
        align-items: center;
        flex-direction: column;
        max-width: 95%;
        height:100%;
        justify-content: space-between;
    }
    .card-body {
        display: flex;
        align-items: center;
        flex-direction: column;
        height: 60%;
        justify-content: flex-start;
    }
    .event-grid {
        overflow-y: auto;
        max-height: 100%;
        box-shadow: none!important;
    }
    .event-card {
        min-width:49% !important;
        height:330px;
        margin-right:1px!important;
        box-shadow: rgba(99, 99, 99, 0.2) 0px 2px 8px 0px;
        background-color: rgba(255, 255, 255, 0.6);
    }
    .event-img {
        height: 40% !important;
        width: 100%;
        object-fit: cover;
        border-top-left-radius: 0.375rem;
        border-top-right-radius: 0.375rem;
    }

    .event-grid::-webkit-scrollbar {
        width: 10px;
        color:black;
    }

    .event-grid::-webkit-scrollbar-thumb {
        background-color: #ffffff;
        border-radius: 4px;
    }
    .loader_events {
        display: flex;
        justify-content: center;
        align-items: center;
        font-weight: bold;
        font-family: 'Segoe UI', sans-serif;
        font-size: 48px;
        color: #4285f4;
        text-align: center;
        border-radius: 8px;
        overflow: hidden;
        border: 1px solid #4285f4;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        height: 100%;
        width: 100%;
        animation: l1 1s linear infinite alternate;
        z-index: 1000;
        background-color: rgba(255, 255, 255, 0.7);
    }
    .loader_events:before {
        content:"Loading Map Markers..."
    }
    .card-body {
        padding:0!important;
    }
    .card-group {
        padding-left:2px!important;
    }
    @@keyframes l1 {to{opacity: 0}}
</style>
